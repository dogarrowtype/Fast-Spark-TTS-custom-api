# FastTTS è¯­éŸ³åˆæˆä¸å…‹éš†å¹³å° ğŸ”Š

[ä¸­æ–‡](README.MD) | [English](README_EN.MD)

> ğŸš€ **FastTTS** - åŸºäºSparkTTSã€OrpheusTTSã€MegaTTS3ç­‰æ¨¡å‹ï¼Œæä¾›é«˜è´¨é‡ä¸­æ–‡è¯­éŸ³åˆæˆä¸å£°éŸ³å…‹éš†æœåŠ¡ã€‚é€šè¿‡ç®€å•æ˜“ç”¨çš„Webç•Œé¢ï¼Œè®©æ‚¨è½»æ¾åˆ›å»ºè‡ªç„¶é€¼çœŸçš„äººå£°ï¼Œæ»¡è¶³å„ç§åœºæ™¯éœ€æ±‚ã€‚

> å¦‚æœé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç»™é¡¹ç›®ç‚¹ä¸ªstarã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **å¤šç§åç«¯åŠ é€Ÿ**: æ”¯æŒ`vllm`ã€`sglang`ã€`llama cpp`ã€`mlx-lm` å¤šç§åŠ é€Ÿç­–ç•¥
- ğŸ¯ **é«˜å¹¶å‘**: é‡‡ç”¨åŠ¨æ€æ‰¹å¤„ç†ï¼Œæå¤§æé«˜å¹¶å‘
- ğŸ›ï¸ **å…¨å‚æ•°æ§åˆ¶**: éŸ³è°ƒã€è¯­é€Ÿã€éŸ³è‰²æ¸©åº¦ç­‰å…¨æ–¹ä½å¯è°ƒ
- ğŸ“± **è½»é‡éƒ¨ç½²**: æœ€å°ä¾èµ–ï¼ŒåŸºäºFlaskå’Œfastapiå¿«é€Ÿå¯åŠ¨
- ğŸ¨ **ç®€æ´ç•Œé¢**: æ ‡å‡†çš„ç°ä»£åŒ–UI
- ğŸ”Š **é•¿æ–‡æœ¬è¯­éŸ³åˆæˆ**: å®ç°è¶…é•¿æ–‡æœ¬è¯­éŸ³åˆæˆï¼Œå¹¶ä¿æŒéŸ³è‰²ä¸€è‡´æ€§ã€‚
- ğŸ”„ **æ”¯æŒæµå¼è¯­éŸ³åˆæˆ**: å®ç°å®æ—¶è¯­éŸ³åˆæˆï¼Œè¾¹ç”Ÿæˆè¾¹æ’­æ”¾ï¼Œé™ä½ç­‰å¾…æ—¶é—´ï¼Œæå‡äº¤äº’ä½“éªŒ
- ğŸ­ **å¤šè§’è‰²è¯­éŸ³åˆæˆ**: æ”¯æŒå¤šè§’è‰²è¯­éŸ³åˆæˆï¼Œå¯åº”ç”¨äºå‰§æœ¬å¯¹è¯åˆæˆã€‚

## ğŸ–¼ï¸ ä½¿ç”¨ç¤ºä¾‹

https://github.com/user-attachments/assets/ab7ca580-45b3-41ba-acfd-b2f68ff62948

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.10+
- fastapi
- vllm æˆ– sglang æˆ– llama-cpp

### ä¸‹è½½æƒé‡

|            æ¨¡å‹             |                                                                                                             huggingface                                                                                                              |                                        modelscope                                         |                                       gguf                                       |
|:-------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------:|
|         Spark-TTS         |                                                                            [SparkAudio/Spark-TTS-0.5B](https://huggingface.co/SparkAudio/Spark-TTS-0.5B)                                                                             |    [SparkAudio/Spark-TTS-0.5B](https://modelscope.cn/models/SparkAudio/Spark-TTS-0.5B)    |    [SparkTTS-LLM-GGUF](https://huggingface.co/mradermacher/SparkTTS-LLM-GGUF)    | 
|        Orpheus-TTS        |                                  [canopylabs/orpheus-3b-0.1-ft](https://huggingface.co/canopylabs/orpheus-3b-0.1-ft) & [hubertsiuzdak/snac_24khz](https://huggingface.co/hubertsiuzdak/snac_24khz)                                   | [canopylabs/orpheus-3b-0.1-ft](https://modelscope.cn/models/canopylabs/orpheus-3b-0.1-ft) | [orpheus-gguf](https://huggingface.co/isaiahbjork/orpheus-3b-0.1-ft-Q4_K_M-GGUF) | 
| Orpheus-TTS(Multilingual) | [orpheus-multilingual-research-release](https://huggingface.co/collections/canopylabs/orpheus-multilingual-research-release-67f5894cd16794db163786ba)  & [hubertsiuzdak/snac_24khz](https://huggingface.co/hubertsiuzdak/snac_24khz) |                                             -                                             |                                        -                                         |
|         MegaTTS3          |                                                                                   [ByteDance/MegaTTS3](https://huggingface.co/ByteDance/MegaTTS3)                                                                                    |                                             -                                             |                                        -                                         |

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

æ¨ç†å¼•æ“å®‰è£… (æŒ‰éœ€æ±‚å®‰è£…ä¸€ä¸ªå³å¯ï¼Œè‹¥æ˜¯ä½¿ç”¨torchæ¨ç†ï¼Œåˆ™å¯ä»¥è·³è¿‡)

- **vLLM**

  vllmç‰ˆæœ¬éœ€è¦å¤§äº`0.7.2`
    ```bash
    pip install vllm
    ```
  å…·ä½“å‚è€ƒé“¾æ¥ï¼šhttps://github.com/vllm-project/vllm


- **llama-cpp**
    ```bash
    pip install llama-cpp-python
    ```

  å¯ä»¥ä»[ä¸‹è½½æƒé‡](#ä¸‹è½½æƒé‡)ä¸‹è½½å·²ç»è½¬å¥½çš„ggufæƒé‡ã€‚spark-ttsè¯·å°†ä¸‹è½½åçš„æƒé‡æ”¾è‡³æ¨¡å‹å­ç›®å½•`LLM`
  ä¸‹ï¼Œorpheus-ttsæ”¾è‡³æ¨¡å‹ç›®å½•ä¸‹ã€‚å¦‚æœæƒ³è¦è‡ªè¡Œè½¬æ¢ï¼Œè¯·ä½¿ç”¨`convert_hf_to_gguf.py`è„šæœ¬è½¬æ¢æƒé‡ï¼Œæ“ä½œæ–¹å¼å¦‚ä¸‹ï¼š

    ```bash
    git clone https://github.com/ggml-org/llama.cpp.git
    
    cd llama.cpp
    
    python convert_hf_to_gguf.py Spark-TTS-0.5B/LLM --outfile Spark-TTS-0.5B/LLM/model.gguf
    ```

- **sglang**

    ```bash
    pip install sglang
    ```

  å…·ä½“å‚è€ƒé“¾æ¥ï¼šhttps://github.com/sgl-project/sglang


- **mlx-lm**

  åœ¨Apple Siliconä¸Šè¿è¡Œå¤§å‹è¯­è¨€æ¨¡å‹ï¼Œé€‚ç”¨äºMacOSã€‚
    ```bash
    pip install mlx-lm
    ```
  å…·ä½“å‚è€ƒé“¾æ¥ï¼šhttps://github.com/ml-explore/mlx-lm

### å¯åŠ¨

1. å…‹éš†é¡¹ç›®ä»“åº“

```bash
git clone https://github.com/HuiResearch/Fast-Spark-TTS.git
cd Fast-Spark-TTS
```

2. å¯åŠ¨SparkTTS APIæœåŠ¡

`backend`å¯æ ¹æ®è‡ªå·±çš„ç¯å¢ƒï¼Œé€‰æ‹©å¯¹åº”çš„æ¨ç†å¼•æ“ã€‚ç›®å‰æ”¯æŒ`torch`ã€`vllm`ã€`sglang`ã€`llama-cpp`ã€`mlx-lm`ã€‚

```bash
python server.py \
--model_path Spark-TTS-0.5B \  # å¯ä¿®æ”¹ä¸ºè‡ªå·±çš„æ¨¡å‹åœ°å€
--backend vllm \  # vllmã€sglangã€torchã€llama-cppã€mlx-lmä»»é€‰ä¸€ä¸ª
--llm_device cuda \
--tokenizer_device cuda \
--detokenizer_device cuda \
--wav2vec_attn_implementation sdpa \
--llm_attn_implementation sdpa \  # å¦‚æœä½¿ç”¨torch engineï¼Œæœ€å¥½å¼€å¯åŠ é€Ÿ
--torch_dtype "bfloat16" \   # å¯¹äºspark-ttsæ¨¡å‹ï¼Œä¸æ”¯æŒbfloat16çš„è®¾å¤‡ï¼Œåªèƒ½è®¾ç½®ä¸ºfloat32.
--max_length 32768 \
--llm_gpu_memory_utilization 0.6 \
--host 0.0.0.0 \
--port 8000
```

åœ¨æµè§ˆå™¨ä¸­è®¿é—®é¡µé¢

```
http://localhost:8000
```

æŸ¥çœ‹apiæ–‡æ¡£

```
http://localhost:8000/docs
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### è¯­éŸ³åˆæˆ

1. åˆ‡æ¢åˆ°ã€Œè¯­éŸ³åˆæˆã€æ ‡ç­¾é¡µ
2. è¾“å…¥éœ€è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬
3. è°ƒæ•´æ€§åˆ«ã€éŸ³è°ƒã€è¯­é€Ÿç­‰å‚æ•°
4. ç‚¹å‡»ã€Œç”Ÿæˆè¯­éŸ³ã€æŒ‰é’®
5. ç­‰å¾…ç”Ÿæˆå®Œæˆåå³å¯æ’­æ”¾æˆ–ä¸‹è½½

### å£°éŸ³å…‹éš†

1. åˆ‡æ¢åˆ°ã€Œå£°éŸ³å…‹éš†ã€æ ‡ç­¾é¡µ
2. è¾“å…¥ç›®æ ‡æ–‡æœ¬
3. ä¸Šä¼ å‚è€ƒéŸ³é¢‘
4. è¾“å…¥å‚è€ƒéŸ³é¢‘å¯¹åº”çš„æ–‡æœ¬
5. è°ƒæ•´å‚æ•°
6. ç‚¹å‡»ã€Œå…‹éš†å£°éŸ³ã€æŒ‰é’®
7. ç­‰å¾…å…‹éš†å®Œæˆåå³å¯æ’­æ”¾æˆ–ä¸‹è½½

### è§’è‰²å…‹éš†

1. åˆ‡æ¢åˆ°ã€Œè§’è‰²å…‹éš†ã€æ ‡ç­¾é¡µ
2. è¾“å…¥ç›®æ ‡æ–‡æœ¬
3. é€‰æ‹©è‡ªå·±å–œæ¬¢çš„è§’è‰²
4. è°ƒæ•´å‚æ•°
5. ç‚¹å‡»ã€Œè§’è‰²å…‹éš†ã€æŒ‰é’®
6. ç­‰å¾…å…‹éš†å®Œæˆåå³å¯æ’­æ”¾æˆ–ä¸‹è½½

## æ¨ç†é€Ÿåº¦

- æ˜¾å¡ï¼š`A800`
- æ¨¡å‹ï¼š`Spark-TTS-0.5B`
- æµ‹è¯•ä½¿ç”¨å‚æ•°å’Œè¯„æµ‹æ–¹å¼å¯å‚è€ƒ[speed_test.py](speed_test.py)
- è¾“å‡ºéŸ³é¢‘é•¿åº¦(audio len)ã€æ¨ç†è€—æ—¶(cost time)å•ä½éƒ½ä¸ºç§’ã€‚
- è¯„æµ‹åŒ…æ‹¬é•¿æ–‡æœ¬å’ŒçŸ­æ–‡æœ¬åœºæ™¯ã€‚
- å®˜æ–¹ä»£ç æœªè¯„æµ‹ï¼Œå¦‚æœ‰éœ€æ±‚ï¼Œå¯è‡ªè¡Œè¯„æµ‹ã€‚

| åœºæ™¯  |  engine   | device | audio len | cost time |  RTF  |
|:---:|:---------:|:------:|:---------:|:---------:|:-----:|
| çŸ­æ–‡æœ¬ | llama-cpp |  cpu   |   7.48    |   6.808   | 0.910 |
| çŸ­æ–‡æœ¬ |   torch   |  gpu   |   7.18    |   7.675   | 1.069 |
| çŸ­æ–‡æœ¬ |   vllm    |  gpu   |   7.24    |   1.664   | 0.230 |
| çŸ­æ–‡æœ¬ |  sglang   |  gpu   |   7.58    |   1.073   | 0.142 |
| é•¿æ–‡æœ¬ | llama-cpp |  cpu   |  121.98   |  117.828  | 0.966 |
| é•¿æ–‡æœ¬ |   torch   |  gpu   |   113.7   |  107.167  | 0.943 |
| é•¿æ–‡æœ¬ |   vllm    |  gpu   |  111.82   |   7.282   | 0.065 |
| é•¿æ–‡æœ¬ |  sglang   |  gpu   |  117.02   |   4.197   | 0.036 |

## æœ¬åœ°ä½¿ç”¨

1. SparkTTSä½¿ç”¨ç¤ºä¾‹ï¼š

```python
from fast_tts import AutoEngine
import asyncio


async def main():
    engine = AutoEngine(
        model_path="checkpoints/Spark-TTS-0.5B",
        max_length=32768,
        backend="vllm"
    )
    wav = await engine.generate_voice_async(
        text="è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ–‡æœ¬ã€‚",
        gender="female",
        temperature=0.9,
        top_p=0.95,
        top_k=50,
        max_tokens=512,
        repetition_penalty=1.0,  # é‡å¤æƒ©ç½šï¼Œå¦‚æœå¤§äº1.0ï¼Œé™ä½é‡å¤tokenç”Ÿæˆçš„æ¦‚ç‡ã€‚å¯é¿å…é•¿æ—¶é—´é™éŸ³tokenç”Ÿæˆ
        length_threshold=50,  # é•¿åº¦é˜ˆå€¼ï¼Œé•¿åº¦å¤§äºè¯¥å€¼çš„æ–‡æœ¬å°†è¢«åˆ‡åˆ†æˆå¤šä¸ªç‰‡æ®µåˆæˆï¼Œé¿å…é•¿æ–‡æœ¬åˆæˆæ¼éŸ³ç­‰é—®é¢˜
        window_size=50,  # é•¿æ–‡æœ¬åˆ‡åˆ†åçš„ç‰‡æ®µé•¿åº¦
    )
    engine.write_audio(wav, "test.wav")


if __name__ == '__main__':
    asyncio.run(main())
```

2. OrpheusTTSä½¿ç”¨ç¤ºä¾‹ï¼š

ç›®å‰æ•ˆæœä¸å¤ªç¨³å®š

```python
from fast_tts import AutoEngine
import asyncio


async def main():
    engine = AutoEngine(
        model_path="checkpoints/3b-zh-ft-research_release",
        snac_path="checkpoints/snac_24khz",
        max_length=8192,
        backend="vllm"
    )
    wav = await engine.speak_async(
        name="é•¿ä¹",
        text="æˆ‘æ˜¯é•¿ä¹å•¦ã€‚",
        temperature=0.9,
        top_p=0.95,
        top_k=50,
        max_tokens=512,
        repetition_penalty=1.0,  # é‡å¤æƒ©ç½šï¼Œå¦‚æœå¤§äº1.0ï¼Œé™ä½é‡å¤tokenç”Ÿæˆçš„æ¦‚ç‡ã€‚å¯é¿å…é•¿æ—¶é—´é™éŸ³tokenç”Ÿæˆ
        length_threshold=50,  # é•¿åº¦é˜ˆå€¼ï¼Œé•¿åº¦å¤§äºè¯¥å€¼çš„æ–‡æœ¬å°†è¢«åˆ‡åˆ†æˆå¤šä¸ªç‰‡æ®µåˆæˆï¼Œé¿å…é•¿æ–‡æœ¬åˆæˆæ¼éŸ³ç­‰é—®é¢˜
        window_size=50,  # é•¿æ–‡æœ¬åˆ‡åˆ†åçš„ç‰‡æ®µé•¿åº¦
    )
    engine.write_audio(wav, "test.wav")


if __name__ == '__main__':
    asyncio.run(main())
```

OrpheusTTSæ¨¡å‹å¯ä½¿ç”¨çš„éŸ³è‰² name è¯·å‚è€ƒï¼š[orpheus_engine.py](fast_tts/engine/orpheus_engine.py)

3. MegaTTS3ä½¿ç”¨ç¤ºä¾‹

```python
from fast_tts import AsyncMega3Engine
import asyncio


async def main():
    engine = AsyncMega3Engine(
        model_path="checkpoints/MegaTTS3",
        backend="vllm",
        tokenizer_device='cuda',
        torch_dtype='float16'
    )
    audio = await engine.clone_voice_async(
        text="å¦ä¸€è¾¹çš„æ¡Œä¸Š,ä¸€ä½è¯»ä¹¦äººå—¤ä¹‹ä»¥é¼»é“,'ä½›å­ä¸‰è—,ç¥å­ç‡•å°é±¼æ˜¯ä»€ä¹ˆæ ·çš„äººç‰©,æå®¶çš„é‚£ä¸ªæå­å¤œå¦‚ä½•ä¸ä»–ä»¬ç›¸æå¹¶è®ºï¼Ÿ",
        # mega ttsæ¨¡å‹çš„å‚è€ƒéŸ³é¢‘æ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œéœ€è¦ä¼ å…¥wavæ–‡ä»¶å’Œç¼–ç åçš„npyæ–‡ä»¶  
        reference_audio=("checkpoints/Chinese_prompt.wav", "checkpoints/Chinese_prompt.npy"),
        max_tokens=512
    )
    engine.write_audio(audio, 'res.wav')


if __name__ == '__main__':
    asyncio.run(main())
```

4. å…·ä½“ä½¿ç”¨æ–¹æ³•å‚è€ƒ [inference.py](inference.py)

## ä½¿ç”¨æç¤º

- `SparkTTS`æ¨¡å‹æƒé‡é‡åŒ–ä¸º`float16`æ— æ³•ä½¿ç”¨ï¼Œ`torch_dtype`è¯·è®¾ç½®ä¸º`bfloat16`æˆ–`float32`ã€‚
- å¦‚æœå‡ºç°é•¿ç©ºç™½éŸ³ï¼Œå¯å°è¯•è°ƒæ•´`repetition_penalty`å‚æ•°ï¼Œå¤§äº`1.0`ä¼šé™ä½é‡å¤tokenç”Ÿæˆçš„æ¦‚ç‡ï¼Œå¯é¿å…é•¿æ—¶é—´é™éŸ³`token`ç”Ÿæˆ(
  SparkTTSçš„é™éŸ³token idä¸º`163406`)ã€‚
- `OrpheusTTS`æ”¯æŒemotion tagï¼Œç›´æ¥åœ¨æ–‡æœ¬ä¸­æ·»åŠ `<tag>`
  å³å¯å®ç°ã€‚æ¯ä¸ªæ¨¡å‹æ”¯æŒçš„tagæ ‡ç­¾è¯·å‚è€ƒï¼š[orpheus_engine.py](fast_tts/engine/orpheus_engine.py) ä¸­ LANG_MAP
- å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œ`MegaTTS3`
  å›¢é˜Ÿæœªä¸Šä¼ WaveVAEç¼–ç å™¨å‚æ•°ã€‚å› æ­¤ï¼Œåªèƒ½ä»æ­¤å¤„é“¾æ¥ä¸‹è½½å‚è€ƒéŸ³é¢‘è¿›è¡Œæ¨ç†ï¼š[å‚è€ƒéŸ³é¢‘](https://drive.google.com/drive/folders/1QhcHWcy20JfqWjgqZX1YM3I6i9u4oNlr)
  ã€‚å¦‚æœéœ€è¦ä½¿ç”¨è‡ªå·±çš„éŸ³é¢‘ï¼Œè¯·å‚è€ƒMegaTTS3é¡¹ç›®çš„è¯´æ˜ï¼š[MegaTTS3](https://github.com/bytedance/MegaTTS3/tree/main?tab=readme-ov-file#inference)

## Reference

1. [Spark-TTS](https://github.com/SparkAudio/Spark-TTS)
2. [Orpheus-TTS](https://github.com/canopyai/Orpheus-TTS)
3. [MegaTTS3](https://github.com/bytedance/MegaTTS3)

## âš ï¸ å…è´£å£°æ˜

è¯¥é¡¹ç›®æä¾›äº†é›¶æ ·æœ¬è¯­éŸ³å…‹éš† TTS æ¨¡å‹ï¼Œæ—¨åœ¨ç”¨äºå­¦æœ¯ç ”ç©¶ã€æ•™è‚²ç›®çš„å’Œåˆæ³•åº”ç”¨ï¼Œä¾‹å¦‚ä¸ªæ€§åŒ–è¯­éŸ³åˆæˆã€è¾…åŠ©æŠ€æœ¯å’Œè¯­è¨€ç ”ç©¶ã€‚

è¯·æ³¨æ„ï¼š

- è¯·å‹¿å°†æ­¤æ¨¡å‹ç”¨äºæœªç»æˆæƒçš„è¯­éŸ³å…‹éš†ã€å†’å……ã€æ¬ºè¯ˆã€è¯ˆéª—ã€æ·±åº¦ä¼ªé€ æˆ–ä»»ä½•éæ³•æ´»åŠ¨ã€‚

- ç¡®ä¿ä½¿ç”¨æ­¤æ¨¡å‹æ—¶éµå®ˆå½“åœ°çš„æ³•å¾‹æ³•è§„å¹¶éµå®ˆé“å¾·æ ‡å‡†ã€‚

- å¼€å‘äººå‘˜å¯¹äºæ­¤æ¨¡å‹çš„ä»»ä½•è¯¯ç”¨ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚

æœ¬é¡¹ç›®æå€¡è´Ÿè´£ä»»åœ°å¼€å‘å’Œä½¿ç”¨äººå·¥æ™ºèƒ½ï¼Œå¹¶é¼“åŠ±ç¤¾åŒºåœ¨äººå·¥æ™ºèƒ½ç ”ç©¶å’Œåº”ç”¨ä¸­åšæŒå®‰å…¨å’Œé“å¾·åŸåˆ™ã€‚

## è®¸å¯åè®®ä¸è‡´è°¢

æœ¬é¡¹ç›®åŸºäº [Spark-TTS](https://github.com/SparkAudio/Spark-TTS) æ„å»ºï¼Œå¹¶é‡‡ç”¨ä¸ SparkTTS
ç›¸åŒçš„å¼€æºè®¸å¯åè®®è¿›è¡Œåˆ†å‘ã€‚è¯¦æƒ…è¯·å‚é˜…åŸå§‹ [SparkTTS è®¸å¯åè®®](https://github.com/SparkAudio/Spark-TTS/blob/main/LICENSE)ã€‚

## Star History

[![Star History Chart](https://api.star-history.com/svg?repos=HuiResearch/Fast-Spark-TTS&type=Date)](https://www.star-history.com/#HuiResearch/Fast-Spark-TTS&Date)